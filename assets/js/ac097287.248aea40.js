"use strict";(self.webpackChunkcromagnoli_portfolio=self.webpackChunkcromagnoli_portfolio||[]).push([[754],{2509(e,n,t){t.r(n),t.d(n,{assets:()=>Oe,contentTitle:()=>Ue,default:()=>We,frontMatter:()=>Fe,metadata:()=>r,toc:()=>Ve});const r=JSON.parse('{"id":"case-studies/progressive-rollout-legacy","title":"Progressive Rollout from Legacy to NextGen Stack (Hybrid Routing)","description":"Modernize without freezing delivery or risking route uptime.","source":"@site/docs/case-studies/progressive-rollout-legacy.mdx","sourceDirName":"case-studies","slug":"/case-studies/progressive-rollout-legacy","permalink":"/cromagnoli/case-studies/progressive-rollout-legacy","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Production-Proven Case Studies","permalink":"/cromagnoli/"},"next":{"title":"Overview","permalink":"/cromagnoli/case-studies/stateless-configurable-modal"}}');var i=t(4848),a=t(8453),s=t(3845),o=t(2444),l=t(467),c=t(6540);const d="card_L5Cs",u="sectionBlock_auDm",h="cardHeader_q076",p="cardBody_xHj7",g="modeHero_iEAx",m="playgroundModeHero_QwF8",f="stickyModeHero_y0xM",v="modeHeroTopRow_FZHQ",x="modeControlRow_gQqa",y="modeHeroLabel_TD8l",b="sectionLabel_Wl6j",j="modeHeroActiveLabel_hXj_",w="modeHeroActiveLabelNextGen_f62k",R="modeHeroActiveLabelLegacy__UDX",N="modeHeroBodyText_zoN1",S="failureCta_Ih2C",k="modeSwitch_Esq4",L="modeThumb_Gdf1",_="modeSwitchLegacy_HKPw",E="modeState_MB_3",T="modeSwitchWrap_y6CE",C="modeSwitchLoading_NXoe",P="modeTooltip_uRis",q="modeTooltipText_WltG",H="logsPanel_ApRo",A="code-block_JmQ_",D="codeBlockTitle_zwrx",I="codeBlockHint_WVzS",M="error-note_jCrx",G="spinner_KhFb",F="iframeWrapper_AAhA",U="recoveryOverlay_Vm16",O="recoveryContent_erWw",V="recoverySwapIcon_NqNl",B="recoveryText_UgZh",W="recoverySubtext__MsQ",z="externalPostForm_VatD",Q="browserChrome_vcXh",X="browserTopBar_tzPr",K="browserLeft_wKum",J="browserControls_Wsph",Y="trafficLights_IwL8",Z="browserTab_PnXM",$="tabSpinner_xOsb",ee="tabBuyMeNotIcon_oSQk",ne="light_vfSi",te="red_tVLN",re="yellow_j3VV",ie="green_wtLH",ae="browserStatus_o1AG",se="backButton_i819",oe="reloadButton_Gh6d",le="addressRow_hpRP",ce="postFormRow__Kog",de="postFeedback_rjxm",ue="sessionNotice_EY4W",he="sessionCountdown_XfnH",pe="sessionNoticeClose_u8ax",ge="address_tlkU",me="addressPath_UelB",fe="copyButton_thX4",ve="copyButtonCopied_kMLK",xe="addressHint_ci4m",ye="spinning_nK14",be="previewFrame_SQ0B",je="iframeCode_ZGpY",we="iframeCodeTitle_zSol",Re="iframeCodeHint_WrQe",Ne="iframeCodePre_d8RM";var Se="running-sneakers",ke="prod1234",Le="https://hybrid-routing-demo.onrender.com",_e=function(){if("undefined"==typeof window)return Le;var e=window.location.hostname;return"localhost"===e||"127.0.0.1"===e?"http://localhost:4001":Le}(),Ee=function(e){var n=new URL(_e+"/pdp/"+Se+"/white-loop-runner/"+ke+"/");return n.searchParams.set("demoSessionId",e),n.toString()},Te=function(e){var n=new URL(_e+"/cdp/"+Se+"/");return n.searchParams.set("demoSessionId",e),n.toString()},Ce=function(e){return e.length>12e3?e.slice(0,12e3)+"\n\x3c!-- truncated --\x3e":e},Pe=function(e){var n,t,r=e.match(/<title[^>]*>([\s\S]*?)<\/title>/i);return null!=(n=null==r||null==(t=r[1])?void 0:t.trim())?n:""},qe=function(e){var n=new Date(e);return Number.isNaN(n.getTime())?e:new Intl.DateTimeFormat(void 0,{hour:"2-digit",minute:"2-digit",second:"2-digit",timeZoneName:"short"}).format(n)};const He=function(){var e=(0,c.useState)("nextgen"),n=e[0],t=e[1],r=(0,c.useState)(!1),a=r[0],Se=r[1],Le=(0,c.useState)("White Loop Runner"),He=Le[0],Ae=Le[1],De=(0,c.useState)(!0),Ie=De[0],Me=De[1],Ge=(0,c.useState)(!1),Fe=Ge[0],Ue=Ge[1],Oe=(0,c.useState)(0),Ve=Oe[0],Be=Oe[1],We=(0,c.useState)(!1),ze=We[0],Qe=We[1],Xe=(0,c.useState)("Waiting for iframe load..."),Ke=Xe[0],Je=Xe[1],Ye=(0,c.useState)(""),Ze=Ye[0],$e=Ye[1],en=(0,c.useState)(""),nn=en[0],tn=en[1],rn=(0,c.useState)(!1),an=rn[0],sn=rn[1],on=(0,c.useState)([]),ln=on[0],cn=on[1],dn=(0,c.useState)("Ready. Submit Product Name, then reload the embedded page to verify server-side updates."),un=dn[0],hn=dn[1],pn=(0,c.useState)(null),gn=pn[0],mn=pn[1],fn=(0,c.useState)(!1),vn=fn[0],xn=fn[1],yn=(0,c.useState)(null),bn=yn[0],jn=yn[1],wn=(0,c.useState)(null),Rn=wn[0],Nn=wn[1],Sn=(0,c.useState)(function(){return Date.now()}),kn=Sn[0],Ln=Sn[1],_n=(0,c.useState)(!1),En=_n[0],Tn=_n[1],Cn=(0,c.useRef)(0),Pn=(0,c.useMemo)(function(){return"doc-"+Date.now().toString(36)+"-"+Math.random().toString(36).slice(2,8)},[]),qn=(0,c.useState)(function(){return Te(Pn)}),Hn=qn[0],An=qn[1],Dn=(0,c.useMemo)(function(){return"progressive-rollout-expired-notice:"+Pn},[Pn]),In=(0,c.useRef)(!1),Mn=(0,c.useCallback)(function(){if("undefined"!=typeof window)try{window.sessionStorage.setItem(Dn,"1")}catch(e){}},[Dn]),Gn=(0,c.useCallback)(function(){if("undefined"!=typeof window)try{window.sessionStorage.removeItem(Dn)}catch(e){}},[Dn]);(0,c.useEffect)(function(){if("undefined"!=typeof window)try{"1"===window.sessionStorage.getItem(Dn)&&(In.current=!0,Tn(!0))}catch(e){}},[Dn]);var Fn=(0,c.useCallback)(function(){In.current=!0,Tn(!0),Mn()},[Mn]),Un=(0,c.useCallback)(function(e){if(e.sessionExpired)return"Demo session expired. Defaults restored, including feature flag state.";if("number"==typeof e.sessionExpiresAt){var n=e.sessionExpiresAt-Date.now();if(n<=0)return"Demo session expired. Defaults restored, including feature flag state.";if(n<=9e5)return"Demo session will expire soon, please refresh the session to continue."}return null},[]),On=(0,c.useCallback)(function(e){mn(e),"string"==typeof e.productName&&e.productName.trim()&&Ae(e.productName),"nextgen"!==e.routingMode&&"legacy"!==e.routingMode||t(e.routingMode),"boolean"==typeof e.simulateFailure&&Se(e.simulateFailure),e.sessionExpired&&Fn(),Nn(Un(e))},[Un,Fn]),Vn=(0,c.useCallback)((0,l.A)((0,o.A)().m(function e(){var n,t,r;return(0,o.A)().w(function(e){for(;;)switch(e.n){case 0:return(n=new URL(_e+"/resolve/"+ke)).searchParams.set("demoSessionId",Pn),n.searchParams.set("legacy","false"),e.n=1,fetch(n.toString());case 1:if((t=e.v).ok){e.n=2;break}throw new Error("Server unreachable");case 2:return e.n=3,t.json();case 3:r=e.v,On(r);case 4:return e.a(2)}},e)})),[On,Pn]);(0,c.useEffect)(function(){var e=!1;return xn(!0),jn(null),Vn().catch(function(){e||(jn("Hybrid routing service unreachable."),mn(null))}).finally(function(){e||xn(!1)}),function(){e=!0}},[Ve,Vn]),(0,c.useEffect)(function(){var e=window.setInterval(function(){return Ln(Date.now())},1e3);return function(){return window.clearInterval(e)}},[]),(0,c.useEffect)(function(){if(gn){var e=window.setInterval(function(){Nn(Un(gn))},3e4);return function(){return window.clearInterval(e)}}},[Un,gn]),(0,c.useEffect)(function(){gn&&Nn(Un(gn))},[Un,kn,gn]),(0,c.useEffect)(function(){In.current||"number"==typeof(null==gn?void 0:gn.sessionExpiresAt)&&(kn<gn.sessionExpiresAt||(Fn(),Nn("Demo session expired. Defaults restored, including feature flag state.")))},[Fn,kn,null==gn?void 0:gn.sessionExpiresAt]),(0,c.useEffect)(function(){var e=function(){var e=(0,l.A)((0,o.A)().m(function e(){var n,t,r;return(0,o.A)().w(function(e){for(;;)switch(e.p=e.n){case 0:if("visible"===document.visibilityState){e.n=1;break}return e.a(2);case 1:if(!In.current){e.n=2;break}return e.a(2);case 2:if(!("number"==typeof(null==gn?void 0:gn.sessionExpiresAt)&&Date.now()>=gn.sessionExpiresAt)){e.n=3;break}return e.a(2);case 3:return e.p=3,(n=new URL(_e+"/session-touch")).searchParams.set("demoSessionId",Pn),e.n=4,fetch(n.toString(),{method:"POST"});case 4:if((t=e.v).ok){e.n=5;break}return e.a(2);case 5:return e.n=6,t.json();case 6:if(!(r=e.v).sessionExpired){e.n=8;break}return Fn(),Nn("Demo session expired. Defaults restored, including feature flag state."),e.n=7,Vn();case 7:return e.a(2);case 8:mn(function(e){var n;return e?Object.assign({},e,{sessionExpired:!1,sessionExpiresAt:null!=(n=r.sessionExpiresAt)?n:e.sessionExpiresAt}):e}),e.n=10;break;case 9:e.p=9,e.v;case 10:return e.a(2)}},e,null,[[3,9]])}));return function(){return e.apply(this,arguments)}}();e();var n=window.setInterval(e,18e4);return function(){return window.clearInterval(n)}},[Fn,Vn,null==gn?void 0:gn.sessionExpiresAt,Pn]),(0,c.useEffect)(function(){var e=function(){"visible"===document.visibilityState&&Vn().catch(function(){})};return document.addEventListener("visibilitychange",e),function(){return document.removeEventListener("visibilitychange",e)}},[Vn]);var Bn=(0,c.useMemo)(function(){return null!=gn&&gn.queryLegacy?"Legacy forced via ?legacy=true":null!=gn&&gn.fallback?"Legacy fallback after NextGen error":"nextgen"===(null==gn?void 0:gn.route)?"NextGen - React Router/Remix (Reactive UI)":"Hapi legacy controller (postback)"},[gn]),Wn=(0,c.useMemo)(function(){var e="legacy"===(null==gn?void 0:gn.route)||(null==gn?void 0:gn.fallback)||(null==gn?void 0:gn.queryLegacy);return j+" "+(e?R:w)},[gn]),zn=(0,c.useMemo)(function(){if(ln.length>0){for(var e,n=[],t=ln.slice(-12),r=(0,s.A)(t);!(e=r()).done;){var i,a=e.value;if("SESSION_END"!==a.marker)if("SESSION_BEGINNING"!==a.marker){var o=qe(a.at);n.push(o+" \xb7 "+a.method+" "+a.path+" \xb7 route="+a.route+" reason="+a.reason+" fallback="+(a.fallback?"yes":"no"))}else{var l;n.push("[SESSION "+(null!=(l=a.sessionId)?l:"unknown")+"] ---------")}else n.push("[SESSION "+(null!=(i=a.sessionId)?i:"unknown")+"] ---------")}return n}return gn?gn.queryLegacy?["Routing hint: ?legacy=true present \u2192 skip NextGen.","Invoking listings.singleListing via Hapi."]:gn.fallback?["NextGen routing activated but a runtime error surfaced.","Resolver falls back to the legacy Hapi handler (notFound fallback)."]:"nextgen"===gn.route?["NextGen routing active \u2192 hitting React Router 7 entrypoint.","viteDevServerSingleton reused; manifest injected on demand."]:["Feature flag disabled \u2192 legacy Hapi controller handles the route."]:["Waiting for the routing service to respond..."]},[gn,ln]),Qn=(0,c.useRef)(null),Xn=(0,c.useRef)(null),Kn=(0,c.useRef)(null),Jn=(0,c.useRef)(!0),Yn=(0,c.useMemo)(function(){return new URL(_e).origin},[]);(0,c.useEffect)(function(){return function(){Kn.current&&clearTimeout(Kn.current)}},[]),(0,c.useEffect)(function(){var e=Xn.current;e&&Jn.current&&(e.scrollTop=e.scrollHeight)},[zn]);(0,c.useEffect)(function(){var e=!1,n=function(){var n=new URL(_e+"/routing-events");n.searchParams.set("after",String(Cn.current)),fetch(n.toString()).then(function(e){if(!e.ok)throw new Error("events unavailable");return e.json()}).then(function(n){if(!e&&Array.isArray(n.events)&&0!==n.events.length){cn(function(e){return[].concat(e,n.events).slice(-40)});var t=n.events[n.events.length-1];t&&"number"==typeof t.id?Cn.current=t.id:"number"==typeof n.latestId&&(Cn.current=n.latestId)}}).catch(function(){})};n();var t=window.setInterval(n,1200);return function(){e=!0,window.clearInterval(t)}},[]);var Zn=nn||Hn,$n=(0,c.useMemo)(function(){try{return new URL(Zn).pathname.includes("/cdp/")}catch(e){return!1}},[Zn]),et=!$n,nt=(0,c.useMemo)(function(){try{return new URL(Zn).pathname.includes("/pdp/")}catch(e){return!1}},[Zn]),tt=(0,c.useMemo)(function(){try{return"true"===new URL(Zn).searchParams.get("legacy")}catch(e){return!1}},[Zn]),rt=nt&&!tt&&"nextgen"===n&&"nextgen"===(null==gn?void 0:gn.route)&&!(null!=gn&&gn.queryLegacy)&&!(null!=gn&&gn.fallback),it=Ze||($n?"Category Detail":"Product Detail"),at=Ie&&a&&nt,st=(0,c.useMemo)(function(){var e=new URL(Hn);return e.searchParams.set("__reload",String(Ve)),e.toString()},[Hn,Ve]),ot=(0,c.useMemo)(function(){var e=new URL(Zn);return e.searchParams.delete("demoSessionId"),e.searchParams.delete("__reload"),e.searchParams.delete("routingMode"),e.toString()},[Zn]),lt=(0,c.useMemo)(function(){try{var e=new URL(ot);return"..."+e.pathname+e.search+e.hash}catch(n){return"..."+ot}},[ot]),ct=(0,c.useMemo)(function(){if(!Rn||!Rn.startsWith("Demo session will expire soon")||"number"!=typeof(null==gn?void 0:gn.sessionExpiresAt))return null;var e=Math.max(0,gn.sessionExpiresAt-kn),n=Math.floor(e/1e3);return Math.floor(n/60)+":"+String(n%60).padStart(2,"0")},[kn,null==gn?void 0:gn.sessionExpiresAt,Rn]),dt=function(){var e=(0,l.A)((0,o.A)().m(function e(n){var t,r,i;return(0,o.A)().w(function(e){for(;;)switch(e.p=e.n){case 0:return n.preventDefault(),t=He.trim()||"White Loop Runner",r=Ee(Pn),Ue(!0),e.p=1,i=new URLSearchParams({productName:t}),e.n=2,fetch(r,{method:"POST",body:i});case 2:if(e.v.ok){e.n=3;break}throw new Error("POST failed");case 3:Ae(t),hn("POST accepted. Click reload to apply in the iframe."),e.n=5;break;case 4:e.p=4,e.v,hn("POST failed. Check service availability.");case 5:return e.p=5,Ue(!1),e.f(5);case 6:return e.a(2)}},e,null,[[1,4,5,6]])}));return function(n){return e.apply(this,arguments)}}();(0,c.useEffect)(function(){var e=function(e){if(e.origin===Yn){var n=e.data;if("IFRAME_NAVIGATION_START"!==(null==n?void 0:n.type)){if("IFRAME_HTML_SNAPSHOT"===(null==n?void 0:n.type)){"string"==typeof n.href&&n.href&&tn(n.href);var t="string"==typeof n.html?n.html:"";if(t){var r=Pe(t);r&&$e(r),Je(Ce(t))}}}else Me(!0)}};return window.addEventListener("message",e),function(){return window.removeEventListener("message",e)}},[Yn]),(0,c.useEffect)(function(){if(Ie){var e=window.setTimeout(function(){Me(!1)},12e3);return function(){return window.clearTimeout(e)}}},[Ie]);var ut=function(){var e=(0,l.A)((0,o.A)().m(function e(){return(0,o.A)().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,navigator.clipboard.writeText(ot);case 1:Qe(!0),setTimeout(function(){return Qe(!1)},1200),e.n=3;break;case 2:e.p=2,e.v,Qe(!1);case 3:return e.a(2)}},e,null,[[0,2]])}));return function(){return e.apply(this,arguments)}}(),ht=function(){var e=(0,l.A)((0,o.A)().m(function e(){var r,i,a;return(0,o.A)().w(function(e){for(;;)switch(e.p=e.n){case 0:return t(r="nextgen"===n?"legacy":"nextgen"),Ue(!0),hn("Updating routing mode to "+r+" via POST..."),e.p=1,i=Ee(Pn),a=new URLSearchParams({routingMode:r}),e.n=2,fetch(i,{method:"POST",body:a});case 2:if(e.v.ok){e.n=3;break}throw new Error("POST failed");case 3:sn(!0),Kn.current&&clearTimeout(Kn.current),Kn.current=setTimeout(function(){return sn(!1)},1e4),hn("Routing mode updated to "+r+". Click reload to apply in iframe."),mn(function(e){return e?Object.assign({},e,{route:r,routingMode:r,fallback:!1,queryLegacy:!1,reason:"legacy"===r?"feature-flag-off":"nextgen-active"}):e}),e.n=5;break;case 4:e.p=4,e.v,t(function(e){return"nextgen"===e?"legacy":"nextgen"}),hn("Routing mode POST failed. Check service availability.");case 5:return e.p=5,Ue(!1),e.f(5);case 6:return e.a(2)}},e,null,[[1,4,5,6]])}));return function(){return e.apply(this,arguments)}}(),pt=function(){var e=(0,l.A)((0,o.A)().m(function e(){var n,t,r;return(0,o.A)().w(function(e){for(;;)switch(e.p=e.n){case 0:return Ue(!0),Me(!0),hn("Triggering NextGen failure via POST..."),e.p=1,n=function(){try{var e=new URL(nn);if(e.pathname.includes("/pdp/"))return e.searchParams.set("demoSessionId",Pn),e.searchParams.delete("legacy"),e.searchParams.delete("fallbackReason"),e.toString()}catch(n){}return Ee(Pn)}(),t=Ee(Pn),r=new URLSearchParams({simulateFailure:"true"}),e.n=2,fetch(t,{method:"POST",body:r});case 2:if(e.v.ok){e.n=3;break}throw new Error("POST failed");case 3:tn(n),An(n),Se(!0),Be(function(e){return e+1}),hn("Failure trigger accepted. Reloading iframe..."),mn(function(e){return e?Object.assign({},e,{route:"legacy",fallback:!0,reason:"nextgen-error",queryLegacy:!0,simulateFailure:!0}):e}),e.n=5;break;case 4:e.p=4,e.v,Me(!1),hn("Failure trigger POST failed. Check service availability.");case 5:return e.p=5,Ue(!1),e.f(5);case 6:return e.a(2)}},e,null,[[1,4,5,6]])}));return function(){return e.apply(this,arguments)}}();return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)("div",{className:d,children:[(0,i.jsx)("div",{className:h,children:"Live User Flow Test Playground"}),(0,i.jsxs)("div",{className:g+" "+m+" "+f,children:[(0,i.jsx)("div",{className:v,children:(0,i.jsx)("div",{className:y,children:"NextGen Rollout Feature Flag Switch for Product Detail Page"})}),(0,i.jsxs)("div",{className:x,children:[(0,i.jsxs)("div",{className:T,children:[an?(0,i.jsx)("div",{className:P,children:(0,i.jsx)("span",{className:q,children:"If you are on the product detail page, use the embedded browser reload button to reload the current page with the selected renderer."})}):null,(0,i.jsxs)("button",{type:"button",className:k+" "+("legacy"===n?_:"")+" "+(Fe?C:""),onClick:ht,"aria-label":"Toggle product detail page routing mode",title:"Toggle product detail page routing mode",disabled:Fe,children:[(0,i.jsx)("span",{className:E,children:"nextgen"===n?"ON":"OFF"}),(0,i.jsx)("span",{className:L})]})]}),(0,i.jsxs)("div",{className:Wn,children:["Current experience: ",Bn]})]}),En?(0,i.jsxs)("div",{className:ue,children:[(0,i.jsx)("span",{children:"Demo session expired. Defaults restored, including feature flag state."}),(0,i.jsx)("button",{type:"button",className:pe,"aria-label":"Dismiss session notice",onClick:function(){In.current=!1,Tn(!1),Gn()},children:"\xd7"})]}):Rn?(0,i.jsxs)("div",{className:ue,children:[(0,i.jsx)("span",{children:Rn}),ct?(0,i.jsx)("span",{className:he,children:ct}):null]}):null]}),(0,i.jsxs)("div",{className:p,children:[bn?(0,i.jsx)("div",{className:M,children:bn}):null,(0,i.jsxs)("div",{className:F,children:[(0,i.jsx)("div",{className:Q,children:(0,i.jsxs)("div",{className:X,children:[(0,i.jsxs)("div",{className:K,children:[(0,i.jsxs)("div",{className:J,children:[(0,i.jsxs)("div",{className:Y,"aria-hidden":"true",children:[(0,i.jsx)("span",{className:ne+" "+te}),(0,i.jsx)("span",{className:ne+" "+re}),(0,i.jsx)("span",{className:ne+" "+ie})]}),(0,i.jsxs)("div",{className:ae,children:[(0,i.jsx)("button",{type:"button",className:se,onClick:function(){if(!Fe&&!Ie&&et){Me(!0),hn("Navigated back.");try{var e;null==(e=Qn.current)||null==(e=e.contentWindow)||e.history.back()}catch(t){var n=Te(Pn);tn(n),An(n),Be(function(e){return e+1})}}},title:"Back to category",disabled:Fe||Ie||!et,children:(0,i.jsx)("svg",{viewBox:"0 0 16 16","aria-hidden":"true",focusable:"false",children:(0,i.jsx)("path",{d:"M9.75 3.25L4.25 8l5.5 4.75v-2.75h3v-4h-3z"})})}),(0,i.jsx)("button",{type:"button",className:oe,onClick:function(){if(!Fe){var e=nn||Hn;tn(e),An(function(){try{var t=new URL(e);return"nextgen"===n&&(t.searchParams.delete("legacy"),t.searchParams.delete("fallbackReason")),t.toString()}catch(r){return e}}),Me(!0),Be(function(e){return e+1})}},title:"Reload",disabled:Fe||Ie,children:"\u27f3"})]})]}),(0,i.jsxs)("div",{className:Z,"aria-hidden":"true",children:[Ie?(0,i.jsx)("span",{className:$+" "+ye}):(0,i.jsx)("span",{className:ee,children:"B"}),it]})]}),(0,i.jsxs)("div",{className:le,children:[(0,i.jsx)("code",{className:ge,children:(0,i.jsx)("span",{className:me,children:lt})}),(0,i.jsx)("button",{type:"button",className:fe+" "+(ze?ve:""),onClick:ut,title:"Copy address",children:ze?"\u2713 Copied":"Copy address"})]}),(0,i.jsx)("div",{className:xe,children:"Optionally, copy this URL to test the route manually in a new tab."})]})}),at?(0,i.jsx)("div",{className:U,"aria-live":"polite",children:(0,i.jsxs)("div",{className:O,children:[(0,i.jsx)("span",{className:V,"aria-hidden":"true",children:"\u21b9"}),(0,i.jsx)("span",{className:B,children:"Switching experience..."}),(0,i.jsx)("span",{className:W,children:"Your data is safe."})]})}):null,(0,i.jsx)("iframe",{ref:Qn,className:be,src:st,onLoad:function(){var e,n,t;Me(!1),(t=null!=(e=null==(n=Qn.current)?void 0:n.contentWindow)?e:null)&&t.postMessage({type:"REQUEST_HTML_SNAPSHOT"},"*");try{var r,i,a,s=null==(r=Qn.current)||null==(r=r.contentWindow)||null==(r=r.location)?void 0:r.href;s&&tn(s);var o=null==(i=Qn.current)||null==(i=i.contentDocument)?void 0:i.title;o&&$e(o);var l=null==(a=Qn.current)||null==(a=a.contentDocument)||null==(a=a.documentElement)?void 0:a.outerHTML;if(!l)return void Je("Unable to read iframe HTML.");var c=Pe(l);c&&$e(c),Je(Ce(l))}catch(d){Je("Cross-origin iframe: waiting for postMessage HTML snapshot...")}},title:"Progressive routing preview"},st)]})]})]}),(0,i.jsxs)("div",{className:g+" "+u,children:[(0,i.jsx)("div",{className:v,children:(0,i.jsx)("div",{className:b,children:"Simulate NextGen failure"})}),(0,i.jsx)("div",{className:N,children:"This flow is resilient by design: when NextGen fails, an error boundary redirects to legacy rendering to minimize user friction."}),(0,i.jsxs)("div",{className:x,children:[(0,i.jsx)("button",{type:"button",className:S,disabled:!rt||Fe||Ie,onClick:pt,children:a?"Failure triggered \ud83d\udd25":"Trigger failure \ud83d\udca5"}),rt?null:(0,i.jsx)("div",{className:N,children:"Disabled until the iframe is on NextGen product detail."})]})]}),(0,i.jsxs)("div",{className:g+" "+u,children:[(0,i.jsx)("div",{className:v,children:(0,i.jsx)("div",{className:b,children:"Live Server Data Editing (REST)"})}),(0,i.jsx)("div",{className:N,children:"Use this control to verify that both renderers consume the same server-side source of truth. Submit an update, then reload the embedded page to confirm consistent data across legacy and NextGen."}),(0,i.jsxs)("form",{className:z,onSubmit:dt,children:[(0,i.jsxs)("div",{className:ce,children:[(0,i.jsx)("input",{id:"pdp-name",value:He,onChange:function(e){return Ae(e.target.value)}}),(0,i.jsx)("button",{type:"submit",disabled:Ie,children:Fe?"Posting...":"POST to server"})]}),(0,i.jsx)("div",{className:de,children:un})]})]}),(0,i.jsxs)("div",{className:je,children:[(0,i.jsx)("div",{className:we,children:"Current iframe HTML"}),(0,i.jsx)("div",{className:Re,children:"Inspect the raw HTML payload returned by the active server renderer before client-side processing. Look for runtime markers such as Vite scripts to validate which stack served the page."}),(0,i.jsx)("pre",{className:Ne,children:Ke})]}),vn?(0,i.jsx)("div",{className:G,children:"Fetching routing state..."}):(0,i.jsxs)("div",{className:H,children:[(0,i.jsx)("div",{className:D,children:"Server Log"}),(0,i.jsx)("div",{className:I,children:"Validate routing decisions by tracking which renderer served each request and, if applicable, why fallback happened."}),(0,i.jsx)("div",{ref:Xn,className:A,onScroll:function(){var e=Xn.current;if(e){var n=e.scrollHeight-e.scrollTop-e.clientHeight;Jn.current=n<24}},children:zn.map(function(e){return(0,i.jsx)("div",{children:e},e)})})]})]})},Ae="header_YYTX",De="box_imL1",Ie="path_hG54",Me="link_hAKV";const Ge=function(e){var n=e.path,t=e.href;return(0,i.jsx)("div",{className:Ae,children:(0,i.jsxs)("div",{className:De,children:[(0,i.jsx)("span",{className:Ie,children:n}),(0,i.jsx)("a",{className:Me,href:t,target:"_blank",rel:"noreferrer noopener",children:"View Source on GitHub"})]})})},Fe={},Ue="Progressive Rollout from Legacy to NextGen Stack (Hybrid Routing)",Oe={},Ve=[{value:"Summary",id:"summary",level:2},{value:"Problem to Solve",id:"problem-to-solve",level:2},{value:"Main Risks Covered",id:"main-risks-covered",level:2},{value:"Architectural Approach",id:"architectural-approach",level:2},{value:"End-to-End Request Flow",id:"end-to-end-request-flow",level:2},{value:"Key Files (Entry Point to Runtime)",id:"key-files-entry-point-to-runtime",level:2},{value:"1) Route registration entry",id:"1-route-registration-entry",level:3},{value:"2) Core hybrid resolver",id:"2-core-hybrid-resolver",level:3},{value:"2.1) Main entry point (<code>resolveRouteController</code>)",id:"21-main-entry-point-resolveroutecontroller",level:4},{value:"2.2) Eligibility gate used by the resolver",id:"22-eligibility-gate-used-by-the-resolver",level:4},{value:"3) Hapi \u2194 React Router adapter",id:"3-hapi--react-router-adapter",level:3},{value:"3.1) Runtime handler bridge",id:"31-runtime-handler-bridge",level:4},{value:"3.2) Hapi request/response adapter",id:"32-hapi-requestresponse-adapter",level:4},{value:"4) Vite runtime service layer",id:"4-vite-runtime-service-layer",level:3},{value:"4.1) Hapi <code>onRequest</code> bridge for Vite middleware",id:"41-hapi-onrequest-bridge-for-vite-middleware",level:4},{value:"5) Route capability map",id:"5-route-capability-map",level:3},{value:"Resilience Design",id:"resilience-design",level:2},{value:"Resilience in Code",id:"resilience-in-code",level:3},{value:"1) Explicit operator fallback short-circuit",id:"1-explicit-operator-fallback-short-circuit",level:4},{value:"2) NextGen runtime failure boundary -&gt; legacy redirect",id:"2-nextgen-runtime-failure-boundary---legacy-redirect",level:4},{value:"Why Mixed TS + JS in This Case",id:"why-mixed-ts--js-in-this-case",level:2},{value:"Product Value",id:"product-value",level:2},{value:"Performance Notes",id:"performance-notes",level:2},{value:"Live Demo",id:"live-demo",level:2},{value:"How to Run the Experience",id:"how-to-run-the-experience",level:3}];function Be(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"progressive-rollout-from-legacy-to-nextgen-stack-hybrid-routing",children:"Progressive Rollout from Legacy to NextGen Stack (Hybrid Routing)"})}),"\n",(0,i.jsx)(n.admonition,{title:"Core Objective",type:"info",children:(0,i.jsx)(n.p,{children:"Modernize without freezing delivery or risking route uptime."})}),"\n",(0,i.jsx)(n.admonition,{title:"Live Demo Available",type:"tip",children:(0,i.jsxs)(n.p,{children:["Short on time? Jump directly to the ",(0,i.jsx)(n.a,{href:"#live-demo",children:"interactive demo"}),"."]})}),"\n",(0,i.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,i.jsx)(n.p,{children:"This case study shows a production-style migration strategy where one URL can be served by either a legacy Hapi controller or a NextGen React Router runtime, with controlled rollout and safe fallback."}),"\n",(0,i.jsx)(n.admonition,{title:"Transparency Disclaimer",type:"note",children:(0,i.jsxs)(n.p,{children:["The documentation scaffolding and page implementation were generated with AI assistance and should not be evaluated as original authored product code.\nIn this case study, the core authored implementation is represented by:\n",(0,i.jsx)(n.code,{children:"server/init/routes.mjs"}),",\n",(0,i.jsx)(n.code,{children:"nextgen-app/routes.ts"}),",\n",(0,i.jsx)(n.code,{children:"nextgen-app/hybrid-routing/paths.ts"}),",\n",(0,i.jsx)(n.code,{children:"nextgen-app/hybrid-routing/routing.ts"}),",\n",(0,i.jsx)(n.code,{children:"nextgen-app/hybrid-routing/vite.ts"}),",\n",(0,i.jsx)(n.code,{children:"nextgen-app/hybrid-routing/fake-feature-flag.ts"}),"\n",(0,i.jsx)(n.code,{children:"server/demo-runtime-services.mjs"})," (entry point for the demo server init and vite middlewares/assets routing)"]})}),"\n",(0,i.jsx)(n.h2,{id:"problem-to-solve",children:"Problem to Solve"}),"\n",(0,i.jsx)(n.p,{children:"I needed to ship a modern stack incrementally while keeping legacy pages stable and revenue-safe."}),"\n",(0,i.jsx)(n.p,{children:"I needed surgical control over rollout blast radius:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Existing URLs could not change."}),"\n",(0,i.jsx)(n.li,{children:"Legacy had to remain the source of safety."}),"\n",(0,i.jsx)(n.li,{children:"Rollout had to be reversible instantly."}),"\n",(0,i.jsx)(n.li,{children:"Failures in NextGen had to degrade gracefully."}),"\n",(0,i.jsx)(n.li,{children:"Observability had to be explicit to prove routing decisions in real traffic."}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"main-risks-covered",children:"Main Risks Covered"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Routing regressions during migration."}),"\n",(0,i.jsx)(n.li,{children:"Hard cutover risk (all-or-nothing releases)."}),"\n",(0,i.jsx)(n.li,{children:"Runtime failures in NextGen breaking user journeys."}),"\n",(0,i.jsx)(n.li,{children:"Operational blind spots (not knowing why a request went legacy vs NextGen)."}),"\n",(0,i.jsx)(n.li,{children:"Fragmented data behavior between old and new renderers."}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"architectural-approach",children:"Architectural Approach"}),"\n",(0,i.jsxs)(n.p,{children:["The solution uses a route-level resolver (",(0,i.jsx)(n.code,{children:"resolveRouteController"}),") that composes both worlds behind the same path."]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Hapi keeps owning route registration and legacy controllers."}),"\n",(0,i.jsx)(n.li,{children:"Resolver checks feature-flag and path eligibility."}),"\n",(0,i.jsx)(n.li,{children:"If eligible, it delegates to a React Router handler adapted to Hapi request/response."}),"\n",(0,i.jsx)(n.li,{children:"If not eligible, it serves legacy immediately."}),"\n",(0,i.jsx)(n.li,{children:"If NextGen fails, it falls back to legacy path safely."}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"This avoids dual public endpoints, keeps migration localized, and preserves rollback."}),"\n",(0,i.jsx)(n.h2,{id:"end-to-end-request-flow",children:"End-to-End Request Flow"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Request enters Hapi route table."}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"resolveRouteController(...)"})," runs for dual-stack paths."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"shouldUseNextGenRouter(request)"})," evaluates flag + route match + fallback query."]}),"\n",(0,i.jsx)(n.li,{children:"NextGen branch: load React Router server build through Vite middleware mode and respond through the Hapi adapter."}),"\n",(0,i.jsx)(n.li,{children:"Legacy branch: execute legacy controller handler directly."}),"\n",(0,i.jsx)(n.li,{children:"Decision and reason are emitted to routing events for debugging and auditability."}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"key-files-entry-point-to-runtime",children:"Key Files (Entry Point to Runtime)"}),"\n",(0,i.jsxs)(n.p,{children:["All files below live in the companion runtime repo used by this demo (",(0,i.jsx)(n.a,{href:"https://github.com/cromagnoli/hybrid-routing-demo",children:(0,i.jsx)(n.code,{children:"hybrid-routing-demo"})}),")."]}),"\n",(0,i.jsx)(n.h3,{id:"1-route-registration-entry",children:"1) Route registration entry"}),"\n",(0,i.jsx)(Ge,{path:"server/init/routes.mjs",href:"https://github.com/cromagnoli/hybrid-routing-demo/blob/main/server/init/routes.mjs#L20"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:'const routes = [\n  {\n    method: "GET",\n    path: "/cdp/{productCategory}/",\n    config: cdp.get,\n  },\n  {\n    method: "GET",\n    path: "/pdp/{productCategory}/{productName}/{productId}/",\n    config: routing.resolveRouteController(\n      pdp.getLegacy,\n      "/pdp/{productCategory}/{productName}/{productId}/"\n    ),\n  },\n  {\n    method: "GET",\n    path: "/checkout/",\n    config: checkout.get,\n  },\n  {\n    method: ["GET", "POST"],\n    path: "/{path*}",\n    config: routing.resolveRouteController(fallback.unmatched, "/{path*}"),\n  },\n];\n'})}),"\n",(0,i.jsx)(n.admonition,{title:"Why it matters",type:"note",children:(0,i.jsxs)(n.p,{children:["Only dual-stack routes use ",(0,i.jsx)(n.code,{children:"resolveRouteController()"}),"; legacy-only routes keep direct controllers."]})}),"\n",(0,i.jsx)(n.h3,{id:"2-core-hybrid-resolver",children:"2) Core hybrid resolver"}),"\n",(0,i.jsxs)(n.h4,{id:"21-main-entry-point-resolveroutecontroller",children:["2.1) Main entry point (",(0,i.jsx)(n.code,{children:"resolveRouteController"}),")"]}),"\n",(0,i.jsx)(Ge,{path:"nextgen-app/hybrid-routing/routing.ts",href:"https://github.com/cromagnoli/hybrid-routing-demo/blob/main/nextgen-app/hybrid-routing/routing.ts#L78"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"export const resolveRouteController = (legacyController: ServerRoute, pathDebugId: string) => ({\n  ...legacyController,\n  handler: async (...handlerArgs) => {\n    try {\n      const [request] = handlerArgs;\n\n      if (shouldUseNextGenRouter(request)) {\n        logger.info('resolveRouteController', 'Running modern routing for', [\n          request?.method?.toUpperCase(),\n          request?.url?.href,\n          serializeLogSegment({ pathDebugId })\n        ]);\n\n        const reactRouterRoutesHandler = await getReactRouterRoutesHandler(request);\n\n        return reactRouterRoutesHandler(...handlerArgs);\n      }\n\n      logger.info('resolveRouteController', 'Running legacy routing for', [\n        request?.method?.toUpperCase(),\n        request?.url?.href,\n        serializeLogSegment({ pathDebugId })\n      ]);\n\n      if (typeof legacyController.handler === 'function') {\n        return legacyController.handler(...handlerArgs);\n      }\n\n      throw new Error('Handler is undefined for legacyController');\n    } catch (error) {\n      logger.error(\n        'resolveRouteController',\n        'Failure resolving Hapi/ReactRouter route handler. Routing to Hapi 404 page...',\n        [serializeLogSegment(error)]\n      );\n\n      return notFound.handler(...handlerArgs);\n    }\n  }\n});\n"})}),"\n",(0,i.jsx)(n.h4,{id:"22-eligibility-gate-used-by-the-resolver",children:"2.2) Eligibility gate used by the resolver"}),"\n",(0,i.jsx)(n.admonition,{title:"Feature-flag route metadata (conceptual)",type:"note",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'// In production, this route allowlist is controlled by the feature-flag platform.\n// For demo purposes, this implementation keeps it local and explicit.\nconst NEXTGEN_ENABLED_ROUTES = ["ProductDetail"];\n'})})}),"\n",(0,i.jsx)(Ge,{path:"nextgen-app/hybrid-routing/routing.ts",href:"https://github.com/cromagnoli/hybrid-routing-demo/blob/main/nextgen-app/hybrid-routing/routing.ts#L133"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'const shouldUseNextGenRouter = (request) => {\n  const hasLegacyFallbackQuery = request?.url?.searchParams?.get("legacy");\n\n  if (hasLegacyFallbackQuery) {\n    return false;\n  }\n\n  const context = parseContext(request);\n  const isPathAvailable = isNextGenPathAvailable(request.path, NEXTGEN_ENABLED_ROUTES);\n\n  return isNextGenRoutingEnabled(context) && isPathAvailable;\n};\n'})}),"\n",(0,i.jsxs)(n.admonition,{title:"Why it matters",type:"note",children:[(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"resolveRouteController"})," is the core entry point, and ",(0,i.jsx)(n.code,{children:"shouldUseNextGenRouter"})," is the focused eligibility gate."]}),(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"?legacy=true"})," acts as an explicit resolver-level override to force legacy. Read more in ",(0,i.jsx)(n.a,{href:"#resilience-in-code",children:"Resilience in Code"}),"."]})]}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"ProductDetail"})," is a route key (not a URL literal). It maps to the declarative path contract in ",(0,i.jsx)(n.code,{children:"paths.ts"}),", and in production this enablement metadata is typically sourced from the feature-flag tool."]})}),"\n",(0,i.jsx)(n.h3,{id:"3-hapi--react-router-adapter",children:"3) Hapi \u2194 React Router adapter"}),"\n",(0,i.jsx)(n.h4,{id:"31-runtime-handler-bridge",children:"3.1) Runtime handler bridge"}),"\n",(0,i.jsx)(Ge,{path:"nextgen-app/hybrid-routing/routing.ts",href:"https://github.com/cromagnoli/hybrid-routing-demo/blob/main/nextgen-app/hybrid-routing/routing.ts#L146"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"const createReactRouterRoutesHandler = async (request: HapiRequest) => {\n  const build = await getViteBuild();\n\n  return createRequestHandler({\n    build,\n    getLoadContext: async () => ({\n      request\n    })\n  });\n};\n\nexport const getReactRouterRoutesHandler = async (request: HapiRequest): Promise<ReturnType<typeof createRequestHandler>> => {\n  return await createReactRouterRoutesHandler(request);\n};\n"})}),"\n",(0,i.jsx)(n.admonition,{title:"Why it matters",type:"note",children:(0,i.jsxs)(n.p,{children:["This is the runtime bridge used by ",(0,i.jsx)(n.code,{children:"resolveRouteController"})," to defer NextGen handler creation until a request is actually eligible."]})}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"getLoadContext"})," is the per-request context portal. It is where Hapi runtime data is injected into React Router loaders/actions (session, request metadata, feature state, and any cross-layer runtime contract)."]})}),"\n",(0,i.jsx)(n.h4,{id:"32-hapi-requestresponse-adapter",children:"3.2) Hapi request/response adapter"}),"\n",(0,i.jsx)(Ge,{path:"nextgen-app/hybrid-routing/react-router-request-response.adapter.ts",href:"https://github.com/cromagnoli/hybrid-routing-demo/blob/main/nextgen-app/hybrid-routing/react-router-request-response.adapter.ts#L23"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'export const createRequestHandler = ({\n  build,\n  getLoadContext,\n  mode = process.env.NODE_ENV\n}: {\n  build: ServerBuild;\n  getLoadContext?: GetLoadContextFunction;\n  mode?: string;\n}) => {\n  const handleRequest = createReactRouterRequestHandler(build, mode);\n\n  return async (hapiReq: HapiRequest, h: ResponseToolkit) => {\n    try {\n      const request = createReactRouterRequest(hapiReq);\n      const loadContext = await getLoadContext?.(hapiReq, h);\n      const response = await handleRequest(request, loadContext);\n\n      return await sendReactRouterResponse(h, response);\n    } catch (error) {\n      logger.error("createRequestHandler", "Failure adapting request to React Router", [\n        serializeLogSegment({\n          method: hapiReq?.method?.toUpperCase?.() ?? hapiReq?.method,\n          path: hapiReq?.path,\n        }),\n        serializeLogSegment(error)\n      ]);\n\n      throw error;\n    }\n  };\n};\n'})}),"\n",(0,i.jsx)(n.admonition,{title:"Why it matters",type:"note",children:(0,i.jsx)(n.p,{children:"This makes NextGen runtime pluggable without replacing Hapi server infrastructure."})}),"\n",(0,i.jsx)(n.h3,{id:"4-vite-runtime-service-layer",children:"4) Vite runtime service layer"}),"\n",(0,i.jsx)(Ge,{path:"nextgen-app/hybrid-routing/vite.ts",href:"https://github.com/cromagnoli/hybrid-routing-demo/blob/main/nextgen-app/hybrid-routing/vite.ts#L35"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"let vite: ViteDevServer | null = null;\n\nconst viteDevServerSingleton = async () => {\n  if (!vite) {\n    vite = await createViteServer();\n  }\n\n  return vite;\n};\n\nexport const getViteDevServer = viteDevServerSingleton;\n\nexport const getViteBuild = async () => {\n  if (shouldRunViteDevServer()) {\n    const viteDevServer = await getViteDevServer();\n\n    return await viteDevServer.ssrLoadModule('virtual:react-router/server-build') as ServerBuild;\n  }\n\n  const viteStaticBuild = await import('../../build/server/index.mjs');\n\n  return viteStaticBuild.importBuild();\n};\n"})}),"\n",(0,i.jsx)(n.admonition,{title:"Why it matters",type:"note",children:(0,i.jsx)(n.p,{children:"Singleton lifecycle avoids per-request boot cost and keeps dev/prod demo behavior deterministic."})}),"\n",(0,i.jsx)(n.admonition,{title:"Demo scope",type:"note",children:(0,i.jsx)(n.p,{children:"The companion demo runtime intentionally runs only the Vite dev-server branch for simplicity. The static-build branch is shown here to preserve the full production control-flow shape."})}),"\n",(0,i.jsxs)(n.h4,{id:"41-hapi-onrequest-bridge-for-vite-middleware",children:["4.1) Hapi ",(0,i.jsx)(n.code,{children:"onRequest"})," bridge for Vite middleware"]}),"\n",(0,i.jsx)(Ge,{path:"server/demo-runtime-services.mjs",href:"https://github.com/cromagnoli/hybrid-routing-demo/blob/main/server/demo-runtime-services.mjs#L601"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"// ...\n\nif (shouldRunViteDevServer()) {\n    /**\n     * Register Vite middleware directly instead of using `Hecks.toPlugin(viteDevServer.middlewares, 'viteDevServer')`\n     * avoiding catch-all duplicate route issues like:\n     * \"Error: New route /{expressPath*} conflicts with existing /{any*} at...\"\n     */\n    hapiServer.ext(\n      'onRequest',\n      async (request, handler) => await registerViteDevMiddlewares({ hapiRequest: request, hapiHandler: handler })\n    );\n} else {\n    hapiServer.route({\n      method: 'GET',\n      path: '/nextgen-assets/{param*}', // Needs to match assets config at vite.config.mts\n      handler: {\n        directory: {\n          path: './build/client/nextgen-assets' // Needs to match assets directory structure at build/client\n        }\n      }\n    });\n}\n\nregisterRoutes(hapiServer);\n\nawait hapiServer.start();\n\n// ...\n"})}),"\n",(0,i.jsx)(n.admonition,{title:"Why it matters",type:"note",children:(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"registerViteDevMiddlewares"})," is a key integration point: it mounts Vite directly in Hapi request lifecycle and avoids catch-all route conflicts during dual-stack rollout."]})}),"\n",(0,i.jsx)(n.h3,{id:"5-route-capability-map",children:"5) Route capability map"}),"\n",(0,i.jsx)(Ge,{path:"nextgen-app/hybrid-routing/paths.ts",href:"https://github.com/cromagnoli/hybrid-routing-demo/blob/main/nextgen-app/hybrid-routing/paths.ts#L1"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'const DualPaths = {\n  ProductDetail: "/pdp/:productCategory/:productName/:productId",\n};\n\n// Exclude RR internal paths from legacy resolver.\nconst InternalPaths = {\n  ReactRouterManifest: "/__manifest",\n};\n'})}),"\n",(0,i.jsx)(n.admonition,{title:"Why it matters",type:"note",children:(0,i.jsx)(n.p,{children:"An explicit allowlist of dual-stack pages prevents accidental routing to NextGen for pages under migration that are not yet production-ready."})}),"\n",(0,i.jsx)(n.h2,{id:"resilience-design",children:"Resilience Design"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Safe fallback path always exists (legacy controller)."}),"\n",(0,i.jsxs)(n.li,{children:["Fallback can be user-forced (",(0,i.jsx)(n.code,{children:"?legacy=true"}),") for incidents and support workflows."]}),"\n",(0,i.jsx)(n.li,{children:"Runtime failures in NextGen are contained and redirected without losing the journey."}),"\n",(0,i.jsx)(n.li,{children:"Wildcard fallback route guarantees unknown paths still resolve predictably."}),"\n",(0,i.jsxs)(n.li,{children:["Routing event logs explain decision reason (",(0,i.jsx)(n.code,{children:"nextgen-active"}),", ",(0,i.jsx)(n.code,{children:"feature-flag-off"}),", ",(0,i.jsx)(n.code,{children:"forced-by-query"}),", etc.)."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"resilience-in-code",children:"Resilience in Code"}),"\n",(0,i.jsx)(n.h4,{id:"1-explicit-operator-fallback-short-circuit",children:"1) Explicit operator fallback short-circuit"}),"\n",(0,i.jsx)(Ge,{path:"nextgen-app/hybrid-routing/routing.ts",href:"https://github.com/cromagnoli/hybrid-routing-demo/blob/main/nextgen-app/hybrid-routing/routing.ts#L133"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'const shouldUseNextGenRouter = (request) => {\n  const hasLegacyFallbackQuery = request?.url?.searchParams?.get("legacy");\n\n  if (hasLegacyFallbackQuery) {\n    return false;\n  }\n\n  // ...\n};\n'})}),"\n",(0,i.jsx)(n.admonition,{title:"Why it matters",type:"note",children:(0,i.jsx)(n.p,{children:"This guarantees deterministic rollback behavior from the edge of the routing decision, before modern runtime execution begins."})}),"\n",(0,i.jsx)(n.h4,{id:"2-nextgen-runtime-failure-boundary---legacy-redirect",children:"2) NextGen runtime failure boundary -> legacy redirect"}),"\n",(0,i.jsx)(Ge,{path:"nextgen-app/routes/pdp.tsx",href:"https://github.com/cromagnoli/hybrid-routing-demo/blob/main/nextgen-app/routes/pdp.tsx#L100"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tsx",children:'const redirectToLegacyFromBoundary = () => {\n  if (typeof window === "undefined") {\n    return;\n  }\n\n  const url = new URL(window.location.href);\n  url.searchParams.set("legacy", "true");\n  url.searchParams.set("fallbackReason", "error-boundary");\n  window.location.assign(url.toString());\n};\n\nclass RedirectToLegacyBoundary extends React.Component {\n  static getDerivedStateFromError() {\n    return { hasError: true };\n  }\n\n  componentDidCatch() {\n    redirectToLegacyFromBoundary();\n  }\n}\n'})}),"\n",(0,i.jsx)(n.admonition,{title:"Why it matters",type:"note",children:(0,i.jsx)(n.p,{children:"If modern rendering fails at runtime, users are automatically moved to the legacy path instead of getting a dead-end error screen."})}),"\n",(0,i.jsx)(n.h2,{id:"why-mixed-ts--js-in-this-case",children:"Why Mixed TS + JS in This Case"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["NextGen routing/runtime modules are authored in TypeScript (",(0,i.jsx)(n.code,{children:"nextgen-app/hybrid-routing/*.ts"}),") and compiled before server start."]}),"\n",(0,i.jsxs)(n.li,{children:["Legacy controllers and runtime orchestration remain JavaScript (",(0,i.jsx)(n.code,{children:".mjs"}),") to mirror the production migration constraints."]}),"\n",(0,i.jsx)(n.li,{children:"This preserves architectural fidelity while still demonstrating typed contracts in the new runtime layer."}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"product-value",children:"Product Value"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Lower migration risk with zero URL churn."}),"\n",(0,i.jsx)(n.li,{children:"Faster incremental delivery by page/path, not by platform rewrite."}),"\n",(0,i.jsx)(n.li,{children:"Better reliability posture through graceful degradation."}),"\n",(0,i.jsx)(n.li,{children:"Easier stakeholder confidence: behavior is testable live with visible logs and HTML payload inspection."}),"\n",(0,i.jsx)(n.li,{children:"Clear rollback strategy without deployment rollback (immediate traffic rollback)."}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"performance-notes",children:"Performance Notes"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"In dev environments, the singleton NextGen runtime avoids repeated startup overhead across requests."}),"\n",(0,i.jsx)(n.li,{children:"Routing checks are lightweight string/path matching plus feature-state checks."}),"\n",(0,i.jsx)(n.li,{children:"Legacy remains direct path for non-enabled pages, so migration does not tax unrelated routes."}),"\n",(0,i.jsx)(n.li,{children:"Adapter avoids duplicate server stacks by reusing current Hapi transport surface."}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"live-demo",children:"Live Demo"}),"\n",(0,i.jsx)(n.h3,{id:"how-to-run-the-experience",children:"How to Run the Experience"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"The iframe starts on a legacy category page."}),"\n",(0,i.jsx)(n.li,{children:"Click the product tile to open product detail."}),"\n",(0,i.jsxs)(n.li,{children:["Use the ",(0,i.jsx)(n.code,{children:"NextGen Rollout Feature Flag Switch"}),", then click the fake browser ",(0,i.jsx)(n.code,{children:"Reload"})," button to apply the current renderer."]}),"\n",(0,i.jsxs)(n.li,{children:["Use ",(0,i.jsx)(n.code,{children:"Trigger failure"})," in NextGen PDP to validate automatic fallback behavior."]}),"\n",(0,i.jsxs)(n.li,{children:["Use ",(0,i.jsx)(n.code,{children:"Live Server Data Editing (REST)"})," and reload to prove both renderers consume the same source of truth."]}),"\n",(0,i.jsxs)(n.li,{children:["Inspect ",(0,i.jsx)(n.code,{children:"Current iframe HTML"})," and ",(0,i.jsx)(n.code,{children:"Server Log"})," to verify renderer ownership and routing reason."]}),"\n"]}),"\n",(0,i.jsx)(He,{})]})}function We(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(Be,{...e})}):Be(e)}}}]);